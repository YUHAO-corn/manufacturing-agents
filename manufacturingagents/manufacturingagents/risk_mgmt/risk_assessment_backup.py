# 风险评估团队
# Risk Assessment Team for Manufacturing

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import AIMessage
import time
import json
from manufacturingagents.manufacturingagents.prompts.prompt_manager import prompt_manager


def create_risk_assessment_team(llm, memory):
    """创建风险评估团队"""
    
    def risk_assessment_node(state):
        print(f"⚠️ [DEBUG] ===== 风险评估团队节点开始 =====")
        
        current_date = state["analysis_date"]
        product_type = state["product_type"]
        company_name = state["company_name"]
        
        print(f"⚠️ [DEBUG] 输入参数: product_type={product_type}, company={company_name}, date={current_date}")
        
        # 从提示词管理器获取系统提示词
        base_system_prompt = prompt_manager.get_prompt("risk_assessment")
        if not base_system_prompt:
            # 如果提示词文件不存在，使用默认提示词
            base_system_prompt = "你是一位专业的制造业补货风险评估专家，负责对补货决策进行全面的风险评估。"
        
        # 结合具体任务信息构建完整的系统提示词
        system_message = f"""{base_system_prompt}

🎯 当前评估任务：
- 分析产品类型: {product_type}
- 分析公司: {company_name}
- 分析日期: {current_date}

📊 需要评估的信息：
- 市场环境分析报告
- 趋势预测分析报告
- 行业资讯分析报告
- 消费者洞察分析报告
- 决策协调报告

📋 特别要求：
- 进行全方位风险评估
- 量化各类风险的影响程度
- 提供风险管理策略
- 制定应急预案
- 报告长度不少于1200字

请基于收集到的所有信息，提供全面的风险评估报告。"""

        # 创建提示词模板
        prompt = ChatPromptTemplate.from_messages([
            ("system", system_message),
            MessagesPlaceholder(variable_name="messages"),
        ])
        
        # 创建链
        chain = prompt | llm
        
        print(f"⚠️ [DEBUG] 调用LLM链...")
        result = chain.invoke(state["messages"])
        
        print(f"⚠️ [DEBUG] LLM调用完成")
        
        # 兼容不同LLM响应格式
        if hasattr(result, 'content'):
            llm_content = result.content
        elif isinstance(result, str):
            llm_content = result
        else:
            llm_content = str(result)
        
        # 生成风险评估报告 - 使用LLM生成的内容
        risk_assessment_report = f"""# 制造业补货风险评估报告

## 智能风险分析结果

{llm_content}

## 评估概述
- **评估时间**: {current_date}
- **评估对象**: {company_name} {product_type}产品补货决策
- **评估范围**: 市场风险、供应链风险、财务风险和运营风险
- **评估方法**: 定性和定量相结合的风险矩阵分析
- **评估时效**: 未来6个月

---
*报告生成时间: {current_date}*
*评估团队: 制造业风险评估专家组*"""
        
        # 更新状态
- **风险等级**: 中等
- **发生概率**: 35%
- **影响程度**: 中等
- **风险描述**: 市场需求可能出现季节性或周期性波动

### 价格波动风险
- **风险等级**: 高
- **发生概率**: 60%
- **影响程度**: 高
- **风险描述**: 原材料价格和产品价格可能出现较大波动

### 竞争风险
- **风险等级**: 中等
- **发生概率**: 45%
- **影响程度**: 中等
- **风险描述**: 行业竞争加剧可能影响市场份额

### 政策风险
- **风险等级**: 低
- **发生概率**: 20%
- **影响程度**: 中等
- **风险描述**: 政策变化可能影响行业发展环境

## 三、供应链风险评估

### 供应商风险
- **风险等级**: 中等
- **发生概率**: 30%
- **影响程度**: 高
- **风险描述**: 关键供应商可能出现供应中断或质量问题

### 物流风险
- **风险等级**: 低
- **发生概率**: 25%
- **影响程度**: 中等
- **风险描述**: 运输和配送环节可能出现延误或损失

### 质量风险
- **风险等级**: 中等
- **发生概率**: 20%
- **影响程度**: 高
- **风险描述**: 产品质量问题可能导致客户投诉和退货

### 交付风险
- **风险等级**: 低
- **发生概率**: 15%
- **影响程度**: 中等
- **风险描述**: 交付延迟可能影响客户满意度

## 四、财务风险评估

### 流动性风险
- **风险等级**: 中等
- **发生概率**: 30%
- **影响程度**: 高
- **风险描述**: 大量补货可能占用过多资金影响流动性

### 信用风险
- **风险等级**: 低
- **发生概率**: 10%
- **影响程度**: 中等
- **风险描述**: 客户信用问题可能导致应收账款风险

### 汇率风险
- **风险等级**: 中等
- **发生概率**: 40%
- **影响程度**: 中等
- **风险描述**: 汇率波动可能影响进出口成本

### 成本风险
- **风险等级**: 高
- **发生概率**: 55%
- **影响程度**: 高
- **风险描述**: 各类成本上升可能压缩利润空间

## 五、运营风险评估

### 库存风险
- **风险等级**: 中等
- **发生概率**: 35%
- **影响程度**: 中等
- **风险描述**: 库存积压或短缺可能影响运营效率

### 技术风险
- **风险等级**: 低
- **发生概率**: 15%
- **影响程度**: 中等
- **风险描述**: 技术变化可能影响产品竞争力

### 人员风险
- **风险等级**: 低
- **发生概率**: 10%
- **影响程度**: 中等
- **风险描述**: 关键人员流失可能影响业务连续性

### 合规风险
- **风险等级**: 低
- **发生概率**: 5%
- **影响程度**: 高
- **风险描述**: 法规合规问题可能导致法律风险

## 六、综合风险分析

### 高风险因素
1. **价格波动风险** - 需要重点关注和管控
2. **成本上升风险** - 直接影响盈利能力

### 中风险因素
1. **需求波动风险** - 需要持续监控
2. **供应商风险** - 需要多元化供应
3. **流动性风险** - 需要资金规划

### 低风险因素
1. **政策风险** - 相对稳定
2. **技术风险** - 影响有限
3. **合规风险** - 可控制

## 七、风险量化结果

### 预期损失
- **总体预期损失**: 补货金额的8-12%
- **最大可能损失**: 补货金额的25-30%
- **风险价值(VaR)**: 95%置信度下的损失不超过补货金额的15%

### 风险调整收益
考虑风险因素后，预期净收益率为12-18%。

## 八、风险管理建议

### 风险回避
- 避免在高风险时期进行大规模补货
- 避免过度集中的供应商依赖

### 风险缓解
- 建立多元化供应商体系
- 加强成本控制和价格监控
- 优化库存管理策略
- 建立质量控制体系

### 风险转移
- 考虑购买相关保险
- 使用金融工具对冲汇率风险
- 与供应商签订价格稳定协议

### 风险承受
- 接受小额的市场波动风险
- 承担正常的运营风险

## 九、应急预案

### 价格暴涨应急预案
1. 立即暂停补货
2. 重新评估市场情况
3. 寻找替代供应商
4. 调整库存策略

### 供应中断应急预案
1. 启动备选供应商
2. 调整生产计划
3. 与客户沟通调整交付
4. 评估影响和损失

### 需求下降应急预案
1. 调整库存水平
2. 加强市场营销
3. 寻找新的销售渠道
4. 优化产品结构

## 十、风险监控体系

### 关键风险指标
- 原材料价格指数
- 库存周转率
- 客户满意度
- 供应商绩效指标

### 监控频率
- 市场价格：每日监控
- 供应商绩效：每周监控
- 库存状况：每周监控
- 财务指标：每月监控

### 报告机制
建立定期风险报告制度，及时预警和应对。

## 十一、风险评估结论

### 总体风险水平：可接受
基于当前分析，补货决策的总体风险水平在可接受范围内。

### 关键风险提示
需要特别关注价格波动风险和成本上升风险。

### 最终风险管理建议
1. 建立完善的风险管理体系
2. 加强关键风险的监控和预警
3. 制定详细的应急预案
4. 定期评估和更新风险策略

**风险评估结论**: 在采取适当风险管理措施的前提下，当前的{product_type}产品补货决策风险可控，建议谨慎推进。

---
*报告生成时间: {current_date}*
*风险评估专家: 风险评估团队*
"""
        
        # 更新状态
        state["risk_assessment_report"] = risk_assessment_report
        state["messages"].append(AIMessage(content=risk_assessment_report))
        
        print(f"⚠️ [DEBUG] 风险评估完成，报告长度: {len(risk_assessment_report)}")
        
        return state
    
    return risk_assessment_node 