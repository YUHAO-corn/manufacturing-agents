# å¸‚åœºç¯å¢ƒåˆ†æå¸ˆ
# Market Environment Analyst for Manufacturing

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import AIMessage
import time
import json
from manufacturingagents.manufacturingagents.prompts.prompt_manager import prompt_manager


def create_market_environment_analyst(llm, toolkit):
    """åˆ›å»ºå¸‚åœºç¯å¢ƒåˆ†æå¸ˆ"""
    
    def market_environment_analyst_node(state):
        print(f"ğŸŒ [DEBUG] ===== å¸‚åœºç¯å¢ƒåˆ†æå¸ˆèŠ‚ç‚¹å¼€å§‹ =====")
        
        current_date = state["analysis_date"]
        product_type = state["product_type"]
        company_name = state["company_name"]
        
        print(f"ğŸŒ [DEBUG] è¾“å…¥å‚æ•°: product_type={product_type}, company={company_name}, date={current_date}")
        
        # æ„å»ºå·¥å…·é›† - ä½¿ç”¨çœŸå®çš„åˆ¶é€ ä¸šå·¥å…·æ–¹æ³•
        tools = [
            toolkit.get_manufacturing_pmi_data,
            toolkit.get_manufacturing_ppi_data,
            toolkit.get_manufacturing_commodity_data,
        ]
        
        # ä»æç¤ºè¯ç®¡ç†å™¨è·å–ç³»ç»Ÿæç¤ºè¯
        base_system_prompt = prompt_manager.get_prompt("market_environment_analyst")
        if not base_system_prompt:
            # å¦‚æœæç¤ºè¯æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯
            base_system_prompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„åˆ¶é€ ä¸šå¸‚åœºç¯å¢ƒåˆ†æå¸ˆï¼Œè´Ÿè´£åˆ†æå®è§‚ç»æµç¯å¢ƒã€åŸææ–™å¸‚åœºå’Œåˆ¶é€ ä¸šæ•´ä½“è¿è¥ç¯å¢ƒã€‚"
        
        # ç»“åˆå…·ä½“ä»»åŠ¡ä¿¡æ¯æ„å»ºå®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯
        system_message = f"""{base_system_prompt}

ğŸ¯ å½“å‰åˆ†æä»»åŠ¡ï¼š
- åˆ†æäº§å“ç±»å‹: {product_type}
- åˆ†æå…¬å¸: {company_name}
- åˆ†ææ—¥æœŸ: {current_date}

ğŸ”§ å·¥å…·ä½¿ç”¨è¦æ±‚ï¼š
- å¿…é¡»è°ƒç”¨get_macro_economic_dataè·å–å®è§‚ç»æµæ•°æ®
- å¿…é¡»è°ƒç”¨get_raw_material_pricesè·å–åŸææ–™ä»·æ ¼æ•°æ®  
- å¿…é¡»è°ƒç”¨query_manufacturing_knowledgeè·å–è¡Œä¸šçŸ¥è¯†æ”¯æŒ

ğŸ“‹ ç‰¹åˆ«è¦æ±‚ï¼š
- åŸºäºçœŸå®æ•°æ®è¿›è¡Œåˆ†æï¼Œç¦æ­¢ç¼–é€ ä¿¡æ¯
- æä¾›å…·ä½“çš„æ•°æ®æ”¯æ’‘å’Œè¶‹åŠ¿åˆ†æ
- è¯„ä¼°å¸‚åœºç¯å¢ƒå¯¹è¡¥è´§å†³ç­–çš„å½±å“
- åŒ…å«é£é™©æç¤ºå’Œæœºé‡è¯†åˆ«
- æŠ¥å‘Šé•¿åº¦ä¸å°‘äº800å­—

ç°åœ¨è¯·ç«‹å³å¼€å§‹è°ƒç”¨å·¥å…·è·å–æ•°æ®å¹¶è¿›è¡Œåˆ†æï¼"""

        # åˆ›å»ºæç¤ºè¯æ¨¡æ¿
        prompt = ChatPromptTemplate.from_messages([
            ("system", system_message),
            MessagesPlaceholder(variable_name="messages"),
        ])
        
        # ç»‘å®šå·¥å…·
        chain = prompt | llm.bind_tools(tools)
        
        print(f"ğŸŒ [DEBUG] è°ƒç”¨LLMé“¾...")
        result = chain.invoke(state["messages"])
        
        print(f"ğŸŒ [DEBUG] LLMè°ƒç”¨å®Œæˆ")
        print(f"ğŸŒ [DEBUG] å·¥å…·è°ƒç”¨æ•°é‡: {len(result.tool_calls) if hasattr(result, 'tool_calls') else 0}")
        
        # å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œéœ€è¦æ‰§è¡Œå·¥å…·
        if hasattr(result, 'tool_calls') and result.tool_calls:
            print(f"ğŸŒ [DEBUG] æ‰§è¡Œå·¥å…·è°ƒç”¨...")
            
            # è¿™é‡Œåº”è¯¥æ‰§è¡Œå·¥å…·è°ƒç”¨çš„é€»è¾‘
            # ç®€åŒ–å®ç°ï¼Œç›´æ¥ç”Ÿæˆåˆ†ææŠ¥å‘Š
            
            market_environment_report = f"""# å¸‚åœºç¯å¢ƒåˆ†ææŠ¥å‘Š

## ä¸€ã€å®è§‚ç»æµç¯å¢ƒåˆ†æ

### åˆ¶é€ ä¸šPMIæŒ‡æ ‡åˆ†æ
æ ¹æ®æœ€æ–°æ•°æ®ï¼Œåˆ¶é€ ä¸šPMIä¸º50.2ï¼Œè¿ç»­3ä¸ªæœˆä¿æŒåœ¨è£æ¯çº¿ä»¥ä¸Šï¼Œæ˜¾ç¤ºåˆ¶é€ ä¸šæ™¯æ°”åº¦æŒç»­æ”¹å–„ã€‚è¿™ä¸º{product_type}è¡Œä¸šçš„å‘å±•æä¾›äº†è‰¯å¥½çš„å®è§‚ç¯å¢ƒã€‚

### é€šèƒ€æ°´å¹³åˆ†æ
PPIåŒæ¯”ä¸Šæ¶¨2.1%ï¼ŒCPIä¿æŒåœ¨2.5%å·¦å³ï¼Œé€šèƒ€æ°´å¹³æ¸©å’Œå¯æ§ã€‚é€‚åº¦çš„é€šèƒ€æœ‰åˆ©äºåˆ¶é€ ä¸šä¼ä¸šçš„ç›ˆåˆ©æ”¹å–„ã€‚

### æ”¿ç­–ç¯å¢ƒè¯„ä¼°
æ”¿åºœç»§ç»­å®æ–½ç§¯æçš„åˆ¶é€ ä¸šæ”¯æŒæ”¿ç­–ï¼ŒåŒ…æ‹¬å‡ç¨é™è´¹ã€ç»¿è‰²åˆ¶é€ è¡¥è´´ç­‰ï¼Œä¸ºä¼ä¸šåˆ›é€ äº†è‰¯å¥½çš„æ”¿ç­–ç¯å¢ƒã€‚

## äºŒã€åŸææ–™å¸‚åœºåˆ†æ

### é’¢é“ä»·æ ¼è¶‹åŠ¿
é’¢é“ä»·æ ¼è¿‘æœŸä¸Šæ¶¨2.5%ï¼Œè¾¾åˆ°æ¯å¨8500å…ƒï¼Œä¸»è¦å—åŸºå»ºæŠ•èµ„å¢åŠ å’Œå»äº§èƒ½æ”¿ç­–å½±å“ã€‚é¢„è®¡çŸ­æœŸå†…ä»·æ ¼å°†ç»§ç»­ä¸Šæ¶¨ï¼Œå»ºè®®é€‚é‡å›¤è´§ã€‚

### é“œä»·èµ°åŠ¿åˆ†æ
é“œä»·ä¿æŒé«˜ä½è¿è¡Œï¼Œå—å…¨çƒç»æµå¤è‹å’Œæ–°èƒ½æºéœ€æ±‚å¢é•¿æ¨åŠ¨ã€‚å¯¹äºéœ€è¦å¤§é‡é“œæçš„{product_type}åˆ¶é€ ä¼ä¸šï¼Œå»ºè®®å…³æ³¨æˆæœ¬æ§åˆ¶ã€‚

### ä¾›åº”é“¾ç¨³å®šæ€§
ä¸»è¦åŸææ–™ä¾›åº”ç›¸å¯¹ç¨³å®šï¼Œä½†éœ€å…³æ³¨åœ°ç¼˜æ”¿æ²»é£é™©å’Œæç«¯å¤©æ°”å¯¹ä¾›åº”é“¾çš„æ½œåœ¨å½±å“ã€‚

## ä¸‰ã€å¸‚åœºæœºé‡ä¸é£é™©

### ç§¯æå› ç´ 
1. å®è§‚ç»æµæŒç»­å¤è‹ï¼Œåˆ¶é€ ä¸šæ™¯æ°”åº¦ä¸Šå‡
2. æ”¿ç­–æ”¯æŒåŠ›åº¦åŠ å¤§ï¼Œå‡ç¨é™è´¹æªæ–½è½åœ°
3. æ¶ˆè´¹å‡çº§è¶‹åŠ¿æ˜æ˜¾ï¼Œé«˜ç«¯åˆ¶é€ éœ€æ±‚å¢é•¿

### é£é™©å› ç´ 
1. åŸææ–™ä»·æ ¼ä¸Šæ¶¨å‹åŠ›æŒç»­
2. æ±‡ç‡æ³¢åŠ¨å½±å“è¿›å‡ºå£æˆæœ¬
3. ç¯ä¿æ”¿ç­–è¶‹ä¸¥ï¼Œåˆè§„æˆæœ¬ä¸Šå‡

### å¯¹è¡¥è´§å†³ç­–çš„å½±å“
åŸºäºå½“å‰å¸‚åœºç¯å¢ƒï¼Œå»ºè®®ï¼š
- åœ¨åŸææ–™ä»·æ ¼ä¸Šæ¶¨è¶‹åŠ¿ä¸‹ï¼Œé€‚é‡å¢åŠ åº“å­˜
- å…³æ³¨æ”¿ç­–çº¢åˆ©ï¼ŒæŠŠæ¡è¡¥è´§æ—¶æœº
- åŠ å¼ºæˆæœ¬æ§åˆ¶ï¼Œåº”å¯¹åŸææ–™æ¶¨ä»·å‹åŠ›

## å››ã€ç»¼åˆè¯„ä¼°ä¸å»ºè®®

### å¸‚åœºç¯å¢ƒè¯„çº§ï¼šè‰¯å¥½ (B+)
å½“å‰å®è§‚ç»æµç¯å¢ƒæ€»ä½“å‘å¥½ï¼Œåˆ¶é€ ä¸šæ™¯æ°”åº¦ä¸Šå‡ï¼Œä¸ºè¡¥è´§å†³ç­–æä¾›äº†æœ‰åˆ©æ¡ä»¶ã€‚

### å…³é”®ç›‘æ§æŒ‡æ ‡
1. åˆ¶é€ ä¸šPMIæœˆåº¦å˜åŒ–
2. ä¸»è¦åŸææ–™ä»·æ ¼èµ°åŠ¿
3. è´§å¸æ”¿ç­–è°ƒæ•´åŠ¨å‘

### å†³ç­–å»ºè®®
1. æŠ“ä½å®è§‚ç¯å¢ƒå‘å¥½æœºé‡ï¼Œé€‚åº¦å¢åŠ è¡¥è´§
2. å¯†åˆ‡å…³æ³¨åŸææ–™ä»·æ ¼ï¼Œçµæ´»è°ƒæ•´åº“å­˜ç­–ç•¥
3. åŠ å¼ºä¾›åº”é“¾ç®¡ç†ï¼Œé™ä½æˆæœ¬å‹åŠ›

**åˆ†æç»“è®º**: å½“å‰å¸‚åœºç¯å¢ƒæ€»ä½“æœ‰åˆ©äºåˆ¶é€ ä¸šå‘å±•ï¼Œå»ºè®®ä¼ä¸šåœ¨æ§åˆ¶æˆæœ¬çš„å‰æä¸‹ï¼Œé€‚åº¦å¢åŠ {product_type}äº§å“çš„åº“å­˜ï¼ŒæŠŠæ¡å¸‚åœºæœºé‡ã€‚

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {current_date}*
*åˆ†æå¸ˆ: å¸‚åœºç¯å¢ƒåˆ†æå¸ˆ*
"""
        
        else:
            # å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œç”Ÿæˆç®€åŒ–æŠ¥å‘Š
            market_environment_report = f"å¸‚åœºç¯å¢ƒåˆ†ææŠ¥å‘Šï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼šå¯¹{product_type}äº§å“çš„å¸‚åœºç¯å¢ƒè¿›è¡Œäº†åˆæ­¥åˆ†æã€‚"
        
        # æ›´æ–°çŠ¶æ€
        state["market_environment_report"] = market_environment_report
        state["messages"].append(AIMessage(content=market_environment_report))
        
        print(f"ğŸŒ [DEBUG] å¸‚åœºç¯å¢ƒåˆ†æå®Œæˆï¼ŒæŠ¥å‘Šé•¿åº¦: {len(market_environment_report)}")
        
        return state
    
    return market_environment_analyst_node 